<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CORPORATE ESCAPE // NexCorp Tower</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
<style>
/* ===== RESET & BASE ===== */
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

html, body {
  width: 100%; height: 100%;
  background: #000;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  font-family: 'Share Tech Mono', 'Courier New', monospace;
}

/* ===== 16:9 GAME WRAPPER ===== */
#game-wrapper {
  position: relative;
  width: 100vw;
  height: calc(100vw * 9 / 16);
  max-width: 1280px;
  max-height: 720px;
  background: #03080f;
  overflow: hidden;
  box-shadow: 0 0 80px rgba(0,255,255,0.15), 0 0 200px rgba(0,100,255,0.08);
}

/* Constrain height when viewport is too short */
@media (max-aspect-ratio: 16/9) {
  #game-wrapper {
    width: calc(100vh * 16 / 9);
    height: 100vh;
  }
}

/* ===== ANIMATED BACKGROUND LAYERS ===== */
.bg-grid {
  position: absolute; inset: 0;
  background-image:
    linear-gradient(rgba(0,255,255,0.04) 1px, transparent 1px),
    linear-gradient(90deg, rgba(0,255,255,0.04) 1px, transparent 1px);
  background-size: 50px 50px;
  animation: grid-drift 25s linear infinite;
  z-index: 0;
}
@keyframes grid-drift {
  0%   { background-position: 0 0; }
  100% { background-position: 50px 50px; }
}

/* City skyline backdrop */
.bg-city {
  position: absolute;
  bottom: 0; left: 0; right: 0;
  height: 45%;
  z-index: 1;
  pointer-events: none;
}
.bg-city svg { width: 100%; height: 100%; display: block; }

/* Atmosphere glow */
.bg-glow {
  position: absolute; inset: 0;
  background:
    radial-gradient(ellipse 60% 40% at 50% 100%, rgba(0,80,160,0.25) 0%, transparent 70%),
    radial-gradient(ellipse 30% 20% at 20% 110%, rgba(0,200,255,0.1) 0%, transparent 60%),
    radial-gradient(ellipse 30% 20% at 80% 110%, rgba(60,0,200,0.12) 0%, transparent 60%);
  z-index: 2; pointer-events: none;
}

/* Scanlines overlay */
.bg-scanlines {
  position: absolute; inset: 0;
  background: repeating-linear-gradient(
    0deg,
    transparent,
    transparent 3px,
    rgba(0,0,0,0.12) 3px,
    rgba(0,0,0,0.12) 4px
  );
  z-index: 98; pointer-events: none;
}

/* ===== HUD ===== */
#hud {
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 48px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 16px;
  background: linear-gradient(to bottom, rgba(0,0,0,0.75) 0%, transparent 100%);
  z-index: 50;
  pointer-events: none;
}

.hud-logo {
  font-family: 'Orbitron', monospace;
  font-size: 0.75rem;
  font-weight: 700;
  letter-spacing: 4px;
  color: rgba(0,255,255,0.5);
  text-transform: uppercase;
}
.hud-left, .hud-right {
  display: flex; align-items: center; gap: 14px;
}
.hud-center {
  flex: 1; display: flex; align-items: center; justify-content: center;
}
.hud-floor {
  font-family: 'Orbitron', monospace;
  font-size: 0.85rem;
  font-weight: 700;
  letter-spacing: 3px;
  color: #0ff;
  text-shadow: 0 0 10px #0ff, 0 0 20px #0ff8;
}
.hud-divider {
  width: 1px; height: 22px;
  background: linear-gradient(to bottom, transparent, #0ff4, transparent);
}
.hud-battery-wrap {
  display: flex; align-items: center; gap: 6px;
  font-size: 0.7rem; color: #0f9; letter-spacing: 2px;
}
.battery-bar {
  display: flex; gap: 2px; align-items: center;
}
.battery-seg {
  width: 10px; height: 12px;
  background: #0f9;
  border: 1px solid #0f96;
  transition: background 0.4s, border-color 0.4s;
  box-shadow: 0 0 4px #0f96;
}
.battery-seg.empty {
  background: transparent;
  border-color: #0f93;
  box-shadow: none;
}
.battery-cap {
  width: 3px; height: 6px;
  background: #0f96;
  border-radius: 0 1px 1px 0;
}
.hud-rec {
  display: flex; align-items: center; gap: 5px;
  font-size: 0.75rem; color: #f55; letter-spacing: 3px;
}
.rec-dot {
  width: 7px; height: 7px;
  background: #f55; border-radius: 50%;
  box-shadow: 0 0 8px #f55;
  animation: blink 1.2s step-end infinite;
}
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0} }

/* ===== SCREENS ===== */
.screen {
  position: absolute; inset: 0;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  opacity: 0; pointer-events: none;
  transition: opacity 0.45s ease;
  z-index: 10;
}
.screen.active { opacity: 1; pointer-events: all; }
.screen.slide-in  { animation: slideIn 0.45s ease forwards; }
.screen.slide-out { animation: slideOut 0.45s ease forwards; }
@keyframes slideIn  { from{ transform:translateX(60px);opacity:0 } to{ transform:translateX(0);opacity:1 } }
@keyframes slideOut { from{ transform:translateX(0);opacity:1 } to{ transform:translateX(-60px);opacity:0 } }

@keyframes dataWipeIn {
  0%   { clip-path: inset(0 100% 0 0); opacity: 0.3; }
  100% { clip-path: inset(0 0% 0 0);   opacity: 1; }
}
.screen.data-wipe-in { animation: dataWipeIn 0.5s cubic-bezier(0.77,0,0.175,1) forwards; }

/* ===== GLITCH EFFECT ===== */
.glitch {
  position: relative;
  animation: glitch-main 2.5s infinite;
}
.glitch::before, .glitch::after {
  content: attr(data-text);
  position: absolute; top: 0; left: 0; width: 100%;
  overflow: hidden;
}
.glitch::before {
  color: #0ff; clip-path: polygon(0 15%,100% 15%,100% 30%,0 30%);
  animation: glitch-top 2.5s infinite; opacity: 0.8;
}
.glitch::after {
  color: #f0f; clip-path: polygon(0 65%,100% 65%,100% 80%,0 80%);
  animation: glitch-bot 2.5s infinite; opacity: 0.8;
}
@keyframes glitch-main {
  0%,82%,100%{transform:none}
  84%{transform:skewX(-3deg) scaleX(1.01)}
  86%{transform:skewX(3deg)}
  88%{transform:skewX(-1deg)}
  90%{transform:none}
}
@keyframes glitch-top {
  0%,81%,100%{transform:none;opacity:0}
  82%{transform:translate(-4px,2px);opacity:0.8;color:#f0f}
  84%{transform:translate(4px,-2px);opacity:0.8;color:#0ff}
  86%{transform:none;opacity:0}
}
@keyframes glitch-bot {
  0%,80%,100%{transform:none;opacity:0}
  81%{transform:translate(4px,2px);opacity:0.8;color:#ff0}
  83%{transform:translate(-4px,-2px);opacity:0.8;color:#f0f}
  85%{transform:none;opacity:0}
}

/* ===== BOOT SCREEN ===== */
#screen-boot {
  gap: 12px;
  background: radial-gradient(ellipse 80% 60% at 50% 60%, #050d1a 0%, #000 100%);
}
.boot-logo-wrap {
  margin-bottom: 6px;
  filter: drop-shadow(0 0 20px rgba(0,255,255,0.6));
  animation: pulse-glow 3s ease-in-out infinite;
}
@keyframes pulse-glow {
  0%,100%{ filter:drop-shadow(0 0 16px rgba(0,255,255,0.5)) }
  50%{ filter:drop-shadow(0 0 32px rgba(0,255,255,0.9)) }
}
.boot-title {
  font-family: 'Orbitron', monospace;
  font-weight: 900;
  font-size: clamp(1.4rem, 4vw, 2.6rem);
  color: #fff;
  letter-spacing: 8px;
  text-transform: uppercase;
  text-shadow: 0 0 20px #0ff, 0 0 40px #0ff8, 0 0 80px #0ff4;
}
.boot-subtitle {
  font-size: clamp(0.7rem, 1.8vw, 1rem);
  color: rgba(0,255,255,0.6);
  letter-spacing: 6px;
  text-transform: uppercase;
}
.boot-version {
  font-size: 0.7rem;
  color: rgba(0,255,255,0.3);
  letter-spacing: 3px;
  margin-top: 4px;
}
.boot-prompt {
  font-size: clamp(0.65rem,1.4vw,0.85rem);
  color: #0ff;
  letter-spacing: 4px;
  animation: blink 1s step-end infinite;
  margin-top: 12px;
}

/* ===== GENERIC BUTTONS ===== */
.btn {
  font-family: 'Orbitron', monospace;
  font-size: clamp(0.65rem, 1.4vw, 0.85rem);
  letter-spacing: 3px;
  text-transform: uppercase;
  color: #0ff;
  background: transparent;
  border: 2px solid rgba(0,255,255,0.4);
  padding: 10px 24px;
  cursor: pointer;
  position: relative; overflow: hidden;
  transition: color 0.25s, border-color 0.25s, box-shadow 0.25s, transform 0.1s;
  clip-path: polygon(8px 0%,100% 0%,calc(100% - 8px) 100%,0% 100%);
}
.btn::before {
  content: '';
  position: absolute; top: 0; left: -110%; width: 100%; height: 100%;
  background: linear-gradient(90deg, transparent, rgba(0,255,255,0.18), transparent);
  transition: left 0.5s;
}
.btn:hover::before { left: 110%; }
.btn:hover {
  border-color: #0ff;
  color: #fff;
  box-shadow: 0 0 24px rgba(0,255,255,0.35), inset 0 0 16px rgba(0,255,255,0.08);
}
.btn:active { transform: scale(0.95); }

/* ===== CONTENT PANEL ===== */
.content-panel {
  background: rgba(0,8,20,0.82);
  border: 1px solid rgba(0,255,255,0.15);
  backdrop-filter: blur(6px);
  padding: clamp(16px,2.5vw,28px);
  max-width: 700px; width: 90%;
  box-shadow:
    0 0 0 1px rgba(0,255,255,0.08),
    0 0 40px rgba(0,255,255,0.06),
    inset 0 0 20px rgba(0,10,30,0.5);
}
.content-panel::before {
  content: '';
  display: block;
  height: 2px;
  background: linear-gradient(90deg, transparent, #0ff, transparent);
  margin-bottom: 12px;
}

/* ===== FLOOR HEADER ===== */
.floor-header {
  font-family: 'Orbitron', monospace;
  font-size: clamp(0.7rem,1.5vw,0.95rem);
  letter-spacing: 5px;
  color: #0ff;
  text-align: center;
  margin-bottom: 14px;
  text-shadow: 0 0 12px #0ff8;
}
.floor-header span { color: rgba(0,255,255,0.5); }

.question-box {
  font-size: clamp(0.85rem,1.8vw,1.1rem);
  color: #b8d8f8;
  line-height: 1.7;
  text-align: center;
  padding: 16px;
  border: 1px solid rgba(0,255,255,0.1);
  background: rgba(0,255,255,0.03);
  margin-bottom: 14px;
}

/* ===== ANSWER BUTTONS ===== */
.answers-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}
.answer-btn {
  font-family: 'Share Tech Mono', monospace;
  font-size: clamp(0.7rem,1.4vw,0.9rem);
  line-height: 1.4;
  color: #7ac;
  background: rgba(0,20,40,0.6);
  border: 1px solid rgba(0,180,255,0.25);
  padding: 10px 14px;
  cursor: pointer;
  text-align: left;
  transition: all 0.2s;
  clip-path: polygon(6px 0%,100% 0%,calc(100% - 6px) 100%,0% 100%);
  position: relative; overflow: hidden;
}
.answer-btn::before {
  content: '';
  position: absolute; top: 0; left: -110%; width: 100%; height: 100%;
  background: linear-gradient(90deg, transparent, rgba(0,200,255,0.1), transparent);
  transition: left 0.4s;
}
.answer-btn:not(:disabled):hover::before { left: 110%; }
.answer-btn:not(:disabled):hover {
  border-color: #0ff;
  color: #fff;
  background: rgba(0,255,255,0.06);
}
.answer-btn:disabled { cursor: default; }
.answer-btn.correct {
  border-color: #0f8 !important;
  color: #0f8 !important;
  background: rgba(0,200,100,0.1) !important;
  box-shadow: 0 0 12px rgba(0,200,80,0.4), 0 0 20px rgba(240,0,240,0.1);
}
.answer-btn.wrong {
  border-color: #f44 !important;
  color: #f44 !important;
  background: rgba(255,50,50,0.1) !important;
  box-shadow: 0 0 12px rgba(255,50,50,0.4);
  animation: shake 0.4s ease;
}
@keyframes shake {
  0%,100%{transform:translateX(0)}
  20%,60%{transform:translateX(-6px)}
  40%,80%{transform:translateX(6px)}
}
.feedback-row {
  display: flex; justify-content: center;
  margin-top: 12px; min-height: 28px;
}
.feedback-msg {
  font-size: clamp(0.65rem,1.2vw,0.8rem);
  letter-spacing: 2px;
  padding: 4px 12px;
  border: 1px solid;
}
.feedback-msg.ok  { color:#0f8; border-color:#0f84; background:rgba(0,200,80,0.06); }
.feedback-msg.err { color:#f44; border-color:#f444; background:rgba(255,50,50,0.06); }

/* ===== DIALOGUE BOX ===== */
#dialogue-box {
  position: absolute;
  bottom: 0; left: 0; right: 0;
  height: 22%;
  background: rgba(0,5,18,0.93);
  border-top: 2px solid rgba(0,255,255,0.3);
  display: flex;
  align-items: center;
  padding: 10px 16px;
  gap: 14px;
  z-index: 60;
}
#dialogue-box.hidden {
  transform: translateY(100%);
  opacity: 0;
  pointer-events: none;
}
#dialogue-box:not(.hidden) {
  animation: materialize 0.4s ease forwards;
}
@keyframes materialize {
  0%   { transform: translateY(20px) scaleY(0.8); opacity: 0; filter: blur(4px); }
  60%  { transform: translateY(-3px) scaleY(1.02); opacity: 0.9; filter: blur(0); }
  100% { transform: translateY(0) scaleY(1); opacity: 1; filter: blur(0); }
}
#dialogue-box::before {
  content: '';
  position: absolute; top: 0; left: 0; right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, #0ff, transparent);
}

/* Aegis avatar */
.aegis-avatar {
  flex-shrink: 0;
  width: clamp(52px,7vw,76px);
  height: clamp(52px,7vw,76px);
  filter: drop-shadow(0 0 8px rgba(0,255,255,0.6));
  animation: aegis-idle 3s ease-in-out infinite;
}
@keyframes aegis-idle {
  0%,100%{ filter:drop-shadow(0 0 8px rgba(0,255,255,0.5)) }
  50%{ filter:drop-shadow(0 0 18px rgba(0,255,255,0.9)) }
}
.aegis-avatar.talking { animation: aegis-talk 0.4s ease-in-out infinite; }
@keyframes aegis-talk {
  0%,100%{ transform:scale(1) }
  50%{ transform:scale(1.04) }
}

.dialogue-content { flex: 1; min-width: 0; }
#dialogue-speaker {
  font-family: 'Orbitron', monospace;
  font-size: clamp(0.6rem,1.1vw,0.75rem);
  letter-spacing: 4px;
  color: #0ff;
  text-shadow: 0 0 8px #0ff;
  margin-bottom: 5px;
}
#dialogue-text {
  font-size: clamp(0.7rem,1.3vw,0.9rem);
  color: #d0e8ff;
  line-height: 1.55;
  min-height: 2.5em;
}
#dialogue-continue {
  font-size: 0.7rem;
  color: rgba(0,255,255,0.55);
  letter-spacing: 2px;
  margin-top: 5px;
  animation: blink 1s step-end infinite;
  display: none;
}

/* ===== FLOOR 5: DRAG AND DROP ===== */
#screen-floor5 .content-panel {
  max-width: 840px;
  padding: clamp(10px,2vw,18px);
}
.dnd-wrapper {
  display: flex;
  gap: clamp(12px,2vw,24px);
  align-items: flex-start;
}
.dnd-col { flex: 1; min-width: 0; }
.dnd-col-label {
  font-family: 'Orbitron', monospace;
  font-size: 0.7rem;
  letter-spacing: 3px;
  color: rgba(0,180,255,0.6);
  text-align: center;
  margin-bottom: 8px;
  padding-bottom: 6px;
  border-bottom: 1px solid rgba(0,255,255,0.15);
}

/* Data drives (draggable items) */
.data-drive {
  display: flex; align-items: center; gap: 8px;
  background: linear-gradient(135deg, #061424 0%, #0c2040 100%);
  border: 1px solid rgba(0,180,255,0.35);
  padding: 7px 10px;
  margin-bottom: 5px;
  cursor: grab;
  font-size: clamp(0.62rem,1.1vw,0.78rem);
  color: #7ce0ff;
  transition: all 0.2s;
  user-select: none;
  position: relative;
  clip-path: polygon(4px 0%,100% 0%,calc(100% - 4px) 100%,0% 100%);
}
.data-drive:hover {
  border-color: #0ff;
  box-shadow: 0 0 14px rgba(0,255,255,0.25);
  background: linear-gradient(135deg, #0a1f38 0%, #142e54 100%);
  transform: translateX(4px);
}
.data-drive.dragging {
  opacity: 0.4; cursor: grabbing;
  transform: scale(0.98);
}
.data-drive.placed { opacity: 0.35; cursor: default; pointer-events: none; }
.drive-icon { font-size: 0.8rem; flex-shrink: 0; }
.drive-label { flex: 1; line-height: 1.3; }

/* Server slots (drop targets) */
.server-slot {
  display: flex; align-items: center; gap: 8px;
  border: 1px dashed rgba(0,180,80,0.4);
  min-height: 38px;
  padding: 5px 10px;
  margin-bottom: 5px;
  font-size: clamp(0.62rem,1.1vw,0.76rem);
  color: rgba(0,180,80,0.5);
  transition: all 0.2s;
  position: relative;
  background: rgba(0,20,10,0.4);
  clip-path: polygon(4px 0%,100% 0%,calc(100% - 4px) 100%,0% 100%);
}
.server-slot.drag-over {
  border-color: #0ff;
  background: rgba(0,255,255,0.07);
  box-shadow: 0 0 12px rgba(0,255,255,0.3) inset;
}
.server-slot.filled {
  border-style: solid;
  border-color: rgba(0,180,255,0.4);
  color: #7ce0ff;
}
.server-slot.correct-slot {
  border-color: #0f8 !important;
  background: rgba(0,200,80,0.1) !important;
  box-shadow: 0 0 14px rgba(0,200,80,0.3) !important;
  animation: slot-accept 0.5s ease;
}
@keyframes slot-accept {
  0%   { transform: scaleX(1); }
  50%  { transform: scaleX(1.03); box-shadow: 0 0 20px rgba(0,255,128,0.6); }
  100% { transform: scaleX(1); }
}
.server-slot.wrong-slot {
  border-color: #f44 !important;
  background: rgba(255,50,50,0.1) !important;
  animation: flash-red 0.6s ease;
}
@keyframes flash-red {
  0%,100%{ background:rgba(255,50,50,0.1) }
  50%{ background:rgba(255,50,50,0.25) }
}
.slot-num {
  font-family: 'Orbitron', monospace;
  font-size: 0.7rem;
  color: rgba(0,180,80,0.5);
  flex-shrink: 0; width: 16px;
}
.slot-content { flex: 1; line-height: 1.3; }
.slot-empty-label { font-style: italic; opacity: 0.5; font-size: 0.65rem; }
.remove-btn {
  font-size: 0.7rem; cursor: pointer;
  color: rgba(255,100,100,0.5); flex-shrink: 0;
  transition: color 0.15s;
  background: none; border: none; padding: 2px 4px;
  line-height: 1;
}
.remove-btn:hover { color: #f55; }

.dnd-actions {
  display: flex; justify-content: center; gap: 12px;
  margin-top: 10px;
}

/* ===== WIN SCREEN ===== */
#screen-win {
  background: radial-gradient(ellipse 80% 60% at 50% 60%, #020d05 0%, #000 100%);
  gap: 14px;
}
.win-title {
  font-family: 'Orbitron', monospace;
  font-weight: 900;
  font-size: clamp(1.2rem,3.5vw,2.2rem);
  color: #0f8;
  letter-spacing: 6px;
  text-shadow: 0 0 20px #0f8, 0 0 50px #0f84;
  animation: win-pulse 2s ease-in-out infinite;
}
@keyframes win-pulse {
  0%,100%{ text-shadow:0 0 20px #0f8,0 0 50px #0f84 }
  50%{ text-shadow:0 0 40px #0f8,0 0 80px #0f8,0 0 120px #0f86 }
}
@keyframes spin-rays {
  from{ transform:translate(-50%,-50%) rotate(0deg) }
  to{ transform:translate(-50%,-50%) rotate(360deg) }
}
.win-sub {
  font-size: clamp(0.65rem,1.4vw,0.85rem);
  color: rgba(0,255,128,0.6);
  letter-spacing: 4px;
  text-align: center;
}
.win-stats {
  font-size: clamp(0.6rem,1.1vw,0.75rem);
  color: rgba(0,255,128,0.45);
  letter-spacing: 2px;
  text-align: center;
}

/* ===== UTILITY ===== */
.mt-8  { margin-top: 8px; }
.mt-12 { margin-top: 12px; }
.tc    { text-align: center; }
.hidden { display: none !important; }

/* ===== HUD TICKER & CLOCK ===== */
.hud-ticker-wrap {
  overflow: hidden; width: clamp(80px,20vw,200px); height: 20px;
}
.hud-ticker {
  display: inline-block; white-space: nowrap;
  font-size: 0.5rem; color: rgba(0,255,255,0.35);
  letter-spacing: 1px;
  animation: ticker-scroll 18s linear infinite;
}
@keyframes ticker-scroll { 0%{transform:translateX(100%)} 100%{transform:translateX(-100%)} }
.hud-clock {
  font-family: 'Orbitron', monospace;
  font-size: 0.75rem;
  color: rgba(0,255,255,0.6);
  letter-spacing: 2px;
}

/* ===== HEX GRID OVERLAY ===== */
.bg-hex-grid {
  position: absolute; inset: 0; z-index: 1; pointer-events: none; opacity: 0.4;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='56' height='100' viewBox='0 0 56 100'%3E%3Cpath d='M28 66L0 50V18L28 2l28 16v32L28 66zm0 0v34' fill='none' stroke='rgba(0,255,255,0.06)' stroke-width='1'/%3E%3C/svg%3E");
  background-size: 56px 100px;
}

/* ===== BOOT TERMINAL ===== */
.boot-terminal {
  font-size: clamp(0.5rem, 1.1vw, 0.65rem);
  color: rgba(0,255,255,0.5);
  letter-spacing: 1px;
  line-height: 1.8;
  text-align: left;
  width: clamp(200px,55vw,480px);
  min-height: 4em;
  margin-bottom: 2px;
}
.boot-terminal .bt-line { opacity: 0; animation: bt-appear 0.1s forwards; }
@keyframes bt-appear { to { opacity: 1; } }

/* ===== FLOOR TRANSITION OVERLAY ===== */
.floor-transition {
  position: absolute; inset: 0;
  background: rgba(0,2,10,0.95);
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  z-index: 200; gap: 16px;
}
.ft-hex {
  font-size: clamp(2rem,6vw,4rem);
  color: #0ff;
  animation: ft-spin 1s linear infinite;
  text-shadow: 0 0 20px #0ff, 0 0 40px #0ff;
}
@keyframes ft-spin { from{transform:rotate(0deg)} to{transform:rotate(360deg)} }
.ft-text {
  font-family: 'Orbitron', monospace;
  font-size: clamp(0.8rem,2vw,1.2rem);
  color: #0ff; letter-spacing: 6px;
  text-shadow: 0 0 12px #0ff;
}
.ft-cn {
  font-family: 'Noto Sans SC', sans-serif;
  font-size: clamp(0.65rem,1.5vw,0.9rem);
  color: rgba(100,220,255,0.65);
  letter-spacing: 2px;
}
.ft-bar-wrap {
  width: clamp(160px,35vw,280px); height: 4px;
  background: rgba(0,255,255,0.15);
  border: 1px solid rgba(0,255,255,0.3);
}
.ft-bar {
  height: 100%; width: 0%;
  background: linear-gradient(90deg, #0ff, #0f8);
  box-shadow: 0 0 8px #0ff;
  transition: width 0.6s ease;
}

/* ===== CORRECT/WRONG OVERLAYS ===== */
.correct-overlay {
  position: absolute; inset: 0;
  background: radial-gradient(circle at 50% 50%, rgba(0,255,128,0.15) 0%, transparent 70%);
  z-index: 150; pointer-events: none;
  animation: correct-pulse 0.8s ease-out forwards;
}
@keyframes correct-pulse {
  0%   { opacity: 0; transform: scale(0.8); }
  30%  { opacity: 1; transform: scale(1); }
  100% { opacity: 0; transform: scale(1.1); }
}
.wrong-overlay {
  position: absolute; inset: 0;
  background: rgba(255,30,30,0.18);
  z-index: 150; pointer-events: none;
  animation: wrong-flash 0.5s ease-out forwards;
}
@keyframes wrong-flash {
  0%,50% { opacity: 1; }
  100%   { opacity: 0; }
}
@keyframes screen-shake {
  0%,100%{transform:translateX(0)}
  20%,60%{transform:translateX(-5px)}
  40%,80%{transform:translateX(5px)}
}
#game-wrapper.shake { animation: screen-shake 0.4s ease; }

/* ===== WIN HELICOPTER ===== */
.win-helicopter {
  position: absolute; bottom: 15%; font-size: clamp(1rem,3vw,2rem);
  opacity: 0;
  animation: heli-rise 3s ease-out 0.5s forwards;
  filter: drop-shadow(0 0 8px rgba(0,255,128,0.8));
  left: 50%; transform: translateX(-50%);
  z-index: 6;
}
@keyframes heli-rise {
  0%   { bottom: 5%; opacity: 0; }
  30%  { opacity: 0.8; }
  100% { bottom: 70%; opacity: 0; }
}

/* ===== BILINGUAL ===== */
.cn-text {
  display: block;
  font-family: 'Noto Sans SC', 'PingFang SC', 'Microsoft YaHei', sans-serif;
  font-size: 0.85em;
  color: rgba(100, 220, 255, 0.65);
  margin-top: 3px;
  font-weight: 400;
  letter-spacing: 0.5px;
}

/* ===== TYPEWRITER CURSOR ===== */
.type-cursor { animation: blink 0.6s step-end infinite; color: #0ff; }
</style>
</head>
<body>

<div id="game-wrapper">

  <!-- ===== BACKGROUND ===== -->
  <div class="bg-grid"></div>
  <div class="bg-hex-grid"></div>

  <!-- City skyline SVG -->
  <div class="bg-city">
    <svg viewBox="0 0 1280 260" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMax meet">
      <defs>
        <linearGradient id="sky-grad" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="#000814" stop-opacity="0"/>
          <stop offset="100%" stop-color="#000814" stop-opacity="1"/>
        </linearGradient>
        <filter id="glow-city">
          <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
          <feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge>
        </filter>
      </defs>
      <!-- Far buildings silhouette -->
      <g fill="#060d1a" filter="url(#glow-city)">
        <rect x="0"    y="180" width="60"  height="80"/>
        <rect x="55"   y="160" width="40"  height="100"/>
        <rect x="90"   y="140" width="55"  height="120"/>
        <rect x="140"  y="170" width="35"  height="90"/>
        <rect x="170"  y="150" width="50"  height="110"/>
        <rect x="215"  y="120" width="65"  height="140"/>
        <rect x="275"  y="160" width="40"  height="100"/>
        <rect x="310"  y="100" width="80"  height="160"/>
        <rect x="385"  y="150" width="45"  height="110"/>
        <rect x="425"  y="130" width="60"  height="130"/>
        <rect x="480"  y="80"  width="90"  height="180"/>
        <rect x="565"  y="140" width="50"  height="120"/>
        <rect x="610"  y="110" width="70"  height="150"/>
        <rect x="675"  y="90"  width="85"  height="170"/>
        <rect x="755"  y="150" width="45"  height="110"/>
        <rect x="795"  y="120" width="65"  height="140"/>
        <rect x="855"  y="75"  width="95"  height="185"/>
        <rect x="945"  y="145" width="50"  height="115"/>
        <rect x="990"  y="105" width="75"  height="155"/>
        <rect x="1060" y="135" width="55"  height="125"/>
        <rect x="1110" y="160" width="40"  height="100"/>
        <rect x="1145" y="115" width="70"  height="145"/>
        <rect x="1210" y="155" width="45"  height="105"/>
        <rect x="1250" y="130" width="30"  height="130"/>
      </g>
      <!-- Window lights on buildings -->
      <g fill="none">
        <!-- Row of yellow windows on tall buildings -->
        <rect x="488" y="100" width="4" height="3" fill="rgba(255,220,100,0.7)"/>
        <rect x="496" y="100" width="4" height="3" fill="rgba(255,220,100,0.5)"/>
        <rect x="504" y="100" width="4" height="3" fill="rgba(255,220,100,0.7)"/>
        <rect x="488" y="108" width="4" height="3" fill="rgba(255,220,100,0.4)"/>
        <rect x="504" y="108" width="4" height="3" fill="rgba(255,220,100,0.6)"/>
        <rect x="488" y="116" width="4" height="3" fill="rgba(255,220,100,0.7)"/>
        <rect x="496" y="116" width="4" height="3" fill="rgba(255,220,100,0.5)"/>
        <rect x="488" y="124" width="4" height="3" fill="rgba(255,220,100,0.3)"/>
        <rect x="504" y="124" width="4" height="3" fill="rgba(255,220,100,0.6)"/>

        <rect x="862" y="90" width="4" height="3" fill="rgba(255,220,100,0.6)"/>
        <rect x="870" y="90" width="4" height="3" fill="rgba(255,220,100,0.7)"/>
        <rect x="878" y="90" width="4" height="3" fill="rgba(255,220,100,0.4)"/>
        <rect x="862" y="99" width="4" height="3" fill="rgba(255,220,100,0.5)"/>
        <rect x="878" y="99" width="4" height="3" fill="rgba(255,220,100,0.7)"/>
        <rect x="862" y="108" width="4" height="3" fill="rgba(255,220,100,0.6)"/>
        <rect x="870" y="108" width="4" height="3" fill="rgba(255,220,100,0.3)"/>
        <rect x="878" y="108" width="4" height="3" fill="rgba(255,220,100,0.7)"/>
        <rect x="862" y="117" width="4" height="3" fill="rgba(255,220,100,0.5)"/>
        <rect x="862" y="126" width="4" height="3" fill="rgba(255,220,100,0.4)"/>
        <rect x="870" y="126" width="4" height="3" fill="rgba(255,220,100,0.6)"/>

        <rect x="315" y="115" width="4" height="3" fill="rgba(100,200,255,0.5)"/>
        <rect x="323" y="115" width="4" height="3" fill="rgba(100,200,255,0.7)"/>
        <rect x="331" y="115" width="4" height="3" fill="rgba(100,200,255,0.4)"/>
        <rect x="315" y="124" width="4" height="3" fill="rgba(100,200,255,0.6)"/>
        <rect x="323" y="124" width="4" height="3" fill="rgba(100,200,255,0.3)"/>
        <rect x="331" y="124" width="4" height="3" fill="rgba(100,200,255,0.7)"/>
        <rect x="315" y="133" width="4" height="3" fill="rgba(100,200,255,0.5)"/>
        <rect x="331" y="133" width="4" height="3" fill="rgba(100,200,255,0.6)"/>
        <rect x="323" y="142" width="4" height="3" fill="rgba(100,200,255,0.4)"/>

        <rect x="683" y="105" width="4" height="3" fill="rgba(255,180,100,0.6)"/>
        <rect x="691" y="105" width="4" height="3" fill="rgba(255,180,100,0.4)"/>
        <rect x="699" y="105" width="4" height="3" fill="rgba(255,180,100,0.7)"/>
        <rect x="707" y="105" width="4" height="3" fill="rgba(255,180,100,0.5)"/>
        <rect x="683" y="114" width="4" height="3" fill="rgba(255,180,100,0.3)"/>
        <rect x="699" y="114" width="4" height="3" fill="rgba(255,180,100,0.6)"/>
        <rect x="683" y="123" width="4" height="3" fill="rgba(255,180,100,0.5)"/>
        <rect x="691" y="123" width="4" height="3" fill="rgba(255,180,100,0.7)"/>
        <rect x="707" y="123" width="4" height="3" fill="rgba(255,180,100,0.4)"/>
      </g>
      <!-- Ground horizon glow -->
      <rect x="0" y="245" width="1280" height="15" fill="rgba(0,80,160,0.15)"/>
      <!-- Sky gradient overlay -->
      <rect x="0" y="0" width="1280" height="260" fill="url(#sky-grad)"/>
    </svg>
  </div>

  <div class="bg-glow"></div>
  <div class="bg-scanlines"></div>

  <!-- Particles canvas -->
  <canvas id="particles-canvas" style="position:absolute;inset:0;z-index:3;pointer-events:none;opacity:0.35;"></canvas>

  <!-- ===== HUD ===== -->
  <div id="hud">
    <div class="hud-left">
      <div class="hud-logo">NexCorp Sec</div>
      <div class="hud-divider"></div>
      <div class="hud-floor" id="hud-floor">FLOOR 0/5</div>
    </div>
    <div class="hud-center">
      <div class="hud-ticker-wrap"><div class="hud-ticker" id="hud-ticker">NEXCORP SEC SYS v2.7 // BREACH ALERT // KNOWLEDGE VERIFICATION PROTOCOL ACTIVE // å®‰å…¨éªŒè¯åè®® // AEGIS ONLINE //</div></div>
    </div>
    <div class="hud-right">
      <div class="hud-battery-wrap">
        <span>PWR</span>
        <div class="battery-bar" id="battery-bar">
          <div class="battery-seg" data-seg="1"></div>
          <div class="battery-seg" data-seg="2"></div>
          <div class="battery-seg" data-seg="3"></div>
          <div class="battery-seg" data-seg="4"></div>
          <div class="battery-seg" data-seg="5"></div>
          <div class="battery-cap"></div>
        </div>
      </div>
      <div class="hud-divider"></div>
      <div class="hud-rec"><div class="rec-dot"></div>REC</div>
      <div class="hud-divider"></div>
      <div class="hud-clock" id="hud-clock">00:00:00</div>
    </div>
  </div>

  <!-- ===== SCREEN: BOOT ===== -->
  <div id="screen-boot" class="screen active">
    <div class="boot-logo-wrap">
      <!-- NexCorp logo SVG -->
      <svg width="90" height="90" viewBox="0 0 90 90" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <radialGradient id="logo-glow" cx="50%" cy="50%" r="50%">
            <stop offset="0%" stop-color="#0ff" stop-opacity="0.2"/>
            <stop offset="100%" stop-color="#0ff" stop-opacity="0"/>
          </radialGradient>
        </defs>
        <circle cx="45" cy="45" r="44" fill="#050a14" stroke="#0ff" stroke-width="1.5" opacity="0.8"/>
        <circle cx="45" cy="45" r="36" fill="none" stroke="rgba(0,255,255,0.2)" stroke-width="1" stroke-dasharray="4 3"/>
        <!-- Hexagon -->
        <polygon points="45,12 72,28 72,62 45,78 18,62 18,28" fill="none" stroke="#0ff" stroke-width="1.5" opacity="0.7"/>
        <!-- Inner eye -->
        <circle cx="45" cy="45" r="14" fill="#061828" stroke="#0ff" stroke-width="1.5"/>
        <circle cx="45" cy="45" r="7"  fill="#0ff" opacity="0.9"/>
        <circle cx="48" cy="42" r="2"  fill="#fff" opacity="0.8"/>
        <!-- Scan line -->
        <line x1="31" y1="45" x2="59" y2="45" stroke="#0ff" stroke-width="0.7" opacity="0.5"/>
        <!-- Corner ticks -->
        <line x1="45" y1="6"  x2="45" y2="10" stroke="#0ff" stroke-width="1.5" opacity="0.8"/>
        <line x1="45" y1="80" x2="45" y2="84" stroke="#0ff" stroke-width="1.5" opacity="0.8"/>
        <line x1="6"  y1="45" x2="10" y2="45" stroke="#0ff" stroke-width="1.5" opacity="0.8"/>
        <line x1="80" y1="45" x2="84" y2="45" stroke="#0ff" stroke-width="1.5" opacity="0.8"/>
      </svg>
    </div>
    <h1 class="boot-title glitch" data-text="CORPORATE ESCAPE">CORPORATE ESCAPE</h1>
    <p class="boot-subtitle">NexCorp Tower &nbsp;//&nbsp; Security Breach Protocol</p>
    <p class="cn-text" style="text-align:center;font-size:clamp(0.6rem,1.5vw,0.85rem);letter-spacing:3px;color:rgba(0,255,255,0.45);">ä¼ä¸šé€ƒè„± // å¥ˆå…‹æ–¯ç§‘æ™®å¤§å¦å…¥ä¾µåè®®</p>
    <p class="boot-version">SYSTEM v2.7.1 &nbsp;|&nbsp; CLASSIFIED: TOP SECRET</p>
    <div id="boot-terminal" class="boot-terminal"></div>
    <p class="boot-prompt" id="boot-prompt">â–¶ PRESS ANY KEY TO BEGIN â—€</p>
  </div>

  <!-- ===== SCREEN: FLOOR 1 ===== -->
  <div id="screen-floor1" class="screen">
    <div class="content-panel">
      <div class="floor-header">
        <span>â—ˆ</span>&nbsp; FLOOR 01 &nbsp;// LOBBY TERMINAL &nbsp;<span>â—ˆ</span>
        <span class="cn-text">å¤§å…ç»ˆç«¯</span>
      </div>
      <div class="question-box" id="q1-text">
        SECURITY QUERY 01 â€” Loadingâ€¦
      </div>
      <div class="answers-grid" id="q1-answers"></div>
      <div class="feedback-row"><div id="q1-feedback" class="feedback-msg hidden"></div></div>
    </div>
  </div>

  <!-- ===== SCREEN: FLOOR 2 ===== -->
  <div id="screen-floor2" class="screen">
    <div class="content-panel">
      <div class="floor-header">
        <span>â—ˆ</span>&nbsp; FLOOR 02 &nbsp;// ARCHIVE VAULT &nbsp;<span>â—ˆ</span>
        <span class="cn-text">æ¡£æ¡ˆä¿é™©åº“</span>
      </div>
      <div class="question-box" id="q2-text">
        SECURITY QUERY 02 â€” Loadingâ€¦
      </div>
      <div class="answers-grid" id="q2-answers"></div>
      <div class="feedback-row"><div id="q2-feedback" class="feedback-msg hidden"></div></div>
    </div>
  </div>

  <!-- ===== SCREEN: FLOOR 3 ===== -->
  <div id="screen-floor3" class="screen">
    <div class="content-panel">
      <div class="floor-header">
        <span>â—ˆ</span>&nbsp; FLOOR 03 &nbsp;// LAW MAINFRAME &nbsp;<span>â—ˆ</span>
        <span class="cn-text">æ³•å¾‹ä¸»æœº</span>
      </div>
      <div class="question-box" id="q3-text">
        SECURITY QUERY 03 â€” Loadingâ€¦
      </div>
      <div class="answers-grid" id="q3-answers"></div>
      <div class="feedback-row"><div id="q3-feedback" class="feedback-msg hidden"></div></div>
    </div>
  </div>

  <!-- ===== SCREEN: FLOOR 4 ===== -->
  <div id="screen-floor4" class="screen">
    <div class="content-panel">
      <div class="floor-header">
        <span>â—ˆ</span>&nbsp; FLOOR 04 &nbsp;// EXECUTIVE LEVEL &nbsp;<span>â—ˆ</span>
        <span class="cn-text">è¡Œæ”¿å±‚</span>
      </div>
      <div class="question-box" id="q4-text">
        SECURITY QUERY 04 â€” Loadingâ€¦
      </div>
      <div class="answers-grid" id="q4-answers"></div>
      <div class="feedback-row"><div id="q4-feedback" class="feedback-msg hidden"></div></div>
    </div>
  </div>

  <!-- ===== SCREEN: FLOOR 5 (DRAG-AND-DROP) ===== -->
  <div id="screen-floor5" class="screen">
    <div class="content-panel" style="max-width:840px;width:94%;">
      <div class="floor-header">
        <span>â—ˆ</span>&nbsp; FLOOR 05 &nbsp;// MAINFRAME CORE â€” FINAL LOCK &nbsp;<span>â—ˆ</span>
        <span class="cn-text">ä¸»æœºæ ¸å¿ƒ â€” æœ€ç»ˆé”å®š</span>
      </div>
      <div class="question-box" style="font-size:clamp(0.7rem,1.2vw,0.85rem);margin-bottom:10px;">
        Arrange the Australian Court Hierarchy into the server slots â€” slot 1 = HIGHEST authority, slot 5 = LOWEST.
        Drag each data drive and drop it into the correct slot to unlock the exit.
        <span class="cn-text">å°†æ¾³å¤§åˆ©äºšæ³•é™¢å±‚çº§æ’åˆ—åˆ°æœåŠ¡å™¨æ’æ§½ä¸­â€”â€”æ’æ§½1=æœ€é«˜æƒå¨ï¼Œæ’æ§½5=æœ€ä½ã€‚å°†æ¯ä¸ªæ•°æ®é©±åŠ¨å™¨æ‹–æ”¾åˆ°æ­£ç¡®çš„æ’æ§½ä¸­ä»¥è§£é”å‡ºå£ã€‚</span>
      </div>
      <div class="dnd-wrapper">
        <!-- Source column -->
        <div class="dnd-col" id="drives-col">
          <div class="dnd-col-label">â—„ DATA DRIVES â–º <span style="font-family:'Noto Sans SC',sans-serif;font-size:0.8em;color:rgba(100,220,255,0.6);">æ•°æ®é©±åŠ¨å™¨</span></div>
          <div id="drives-container"></div>
        </div>
        <!-- Target column -->
        <div class="dnd-col" id="slots-col">
          <div class="dnd-col-label">â—„ SERVER SLOTS â–º <span style="font-family:'Noto Sans SC',sans-serif;font-size:0.8em;color:rgba(100,220,255,0.6);">æœåŠ¡å™¨æ’æ§½</span></div>
          <div id="slots-container"></div>
        </div>
      </div>
      <div class="dnd-actions">
        <button class="btn" id="submit-btn">SUBMIT &nbsp;â–¶â–¶ <span style="font-family:'Noto Sans SC',sans-serif;font-size:0.75em;">æäº¤</span></button>
        <button class="btn" id="reset-btn" style="border-color:rgba(255,100,100,0.4);color:rgba(255,150,150,0.8);">RESET <span style="font-family:'Noto Sans SC',sans-serif;font-size:0.75em;">é‡ç½®</span></button>
      </div>
      <div class="feedback-row mt-8"><div id="f5-feedback" class="feedback-msg hidden"></div></div>
    </div>
  </div>

  <!-- ===== SCREEN: WIN ===== -->
  <div id="screen-win" class="screen">
    <!-- Particle burst via CSS -->
    <div style="position:absolute;inset:0;pointer-events:none;z-index:5;overflow:hidden">
      <!-- animated rays -->
      <div style="position:absolute;top:50%;left:50%;width:600px;height:600px;transform:translate(-50%,-50%);
        background:conic-gradient(rgba(0,255,128,0.04) 0deg,transparent 10deg,rgba(0,255,128,0.04) 20deg,transparent 30deg,rgba(0,255,128,0.04) 40deg,transparent 50deg,rgba(0,255,128,0.04) 60deg,transparent 70deg,rgba(0,255,128,0.04) 80deg,transparent 90deg,rgba(0,255,128,0.04) 100deg,transparent 110deg,rgba(0,255,128,0.04) 120deg,transparent 130deg,rgba(0,255,128,0.04) 140deg,transparent 150deg,rgba(0,255,128,0.04) 160deg,transparent 170deg,rgba(0,255,128,0.04) 180deg,transparent 190deg,rgba(0,255,128,0.04) 200deg,transparent 210deg,rgba(0,255,128,0.04) 220deg,transparent 230deg,rgba(0,255,128,0.04) 240deg,transparent 250deg,rgba(0,255,128,0.04) 260deg,transparent 270deg,rgba(0,255,128,0.04) 280deg,transparent 290deg,rgba(0,255,128,0.04) 300deg,transparent 310deg,rgba(0,255,128,0.04) 320deg,transparent 330deg,rgba(0,255,128,0.04) 340deg,transparent 350deg);
        animation:spin-rays 20s linear infinite;border-radius:50%;">
      </div>
    </div>
    <div class="win-helicopter" id="win-heli">ğŸš</div>
    <div class="win-title glitch" data-text="ACCESS GRANTED" style="z-index:10;">ACCESS GRANTED</div>
    <p class="win-sub" style="z-index:10;">ESCAPE SEQUENCE COMPLETE â€” NEXCORP TOWER UNLOCKED<span class="cn-text" style="color:rgba(0,255,128,0.5);">é€ƒè„±åºåˆ—å®Œæˆ â€” å¥ˆå…‹æ–¯ç§‘æ™®å¤§å¦å·²è§£é”</span></p>
    <p class="win-stats" id="win-stats" style="z-index:10;margin-top:4px;"></p>
    <div style="z-index:10;margin-top:18px;">
      <button class="btn" id="replay-btn" style="border-color:rgba(0,255,128,0.5);color:#0f8;">
        â†º &nbsp; PLAY AGAIN
      </button>
    </div>
    <div style="z-index:10;margin-top:10px;font-size:0.7rem;color:rgba(0,255,128,0.4);letter-spacing:2px;text-align:center;">
      KNOWLEDGE IS THE KEY â€” WELL DONE, AGENT.
      <span class="cn-text" style="color:rgba(0,255,128,0.35);">çŸ¥è¯†æ˜¯é’¥åŒ™ â€” å¹²å¾—å¥½ï¼Œç‰¹å·¥ã€‚</span>
    </div>
  </div>

  <!-- ===== DIALOGUE BOX ===== -->
  <div id="dialogue-box" class="hidden">
    <!-- Aegis avatar SVG -->
    <svg class="aegis-avatar" id="aegis-svg" viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg">
      <!-- Outer casing -->
      <circle cx="40" cy="40" r="38" fill="#04091a" stroke="#0ff" stroke-width="1.5"/>
      <!-- Rotating ring -->
      <circle cx="40" cy="40" r="31" fill="none" stroke="rgba(0,255,255,0.15)" stroke-width="1"
        stroke-dasharray="5 3">
        <animateTransform attributeName="transform" type="rotate" from="0 40 40" to="360 40 40" dur="8s" repeatCount="indefinite"/>
      </circle>
      <!-- Counter-rotating ring -->
      <circle cx="40" cy="40" r="26" fill="none" stroke="rgba(240,0,240,0.1)" stroke-width="1" stroke-dasharray="3 5">
        <animateTransform attributeName="transform" type="rotate" from="360 40 40" to="0 40 40" dur="5s" repeatCount="indefinite"/>
      </circle>
      <!-- Tech lines -->
      <line x1="9"  y1="40" x2="16" y2="40" stroke="#0ff" stroke-width="0.8" opacity="0.7"/>
      <line x1="64" y1="40" x2="71" y2="40" stroke="#0ff" stroke-width="0.8" opacity="0.7"/>
      <line x1="40" y1="9"  x2="40" y2="16" stroke="#0ff" stroke-width="0.8" opacity="0.7"/>
      <line x1="40" y1="64" x2="40" y2="71" stroke="#0ff" stroke-width="0.8" opacity="0.7"/>
      <!-- Iris ring -->
      <circle cx="40" cy="40" r="20" fill="#061420" stroke="#0ff" stroke-width="1.5"/>
      <!-- Inner iris pattern -->
      <circle cx="40" cy="40" r="15" fill="none" stroke="rgba(0,255,255,0.3)" stroke-width="0.7" stroke-dasharray="3 2"/>
      <!-- Pupil -->
      <circle cx="40" cy="40" r="9" fill="#0ff" opacity="0.95"/>
      <!-- Specular -->
      <circle cx="44" cy="36" r="2.5" fill="white" opacity="0.75"/>
      <!-- Scan beam -->
      <line x1="21" y1="40" x2="59" y2="40" stroke="#0ff" stroke-width="0.6" opacity="0.4">
        <animate attributeName="y1" values="30;50;30" dur="2.5s" repeatCount="indefinite"/>
        <animate attributeName="y2" values="30;50;30" dur="2.5s" repeatCount="indefinite"/>
      </line>
      <!-- Version tag -->
      <text x="40" y="72" text-anchor="middle" fill="rgba(0,255,255,0.4)" font-size="5" font-family="monospace">AEGIS v2.7</text>
    </svg>
    <div class="dialogue-content">
      <div id="dialogue-speaker">AEGIS</div>
      <div id="dialogue-text"></div>
      <div id="dialogue-continue">â–¼ CONTINUE</div>
    </div>
  </div>

  <!-- Floor transition overlay -->
  <div id="floor-transition" class="floor-transition hidden">
    <div class="ft-hex">&#x2B21;</div>
    <div class="ft-text" id="ft-text">ACCESSING FLOOR 01...</div>
    <div class="ft-cn" id="ft-cn">æ­£åœ¨è®¿é—®ç¬¬ä¸€å±‚...</div>
    <div class="ft-bar-wrap"><div class="ft-bar" id="ft-bar"></div></div>
  </div>

  <!-- Correct / Wrong overlays -->
  <div id="correct-overlay" class="correct-overlay hidden"></div>
  <div id="wrong-overlay" class="wrong-overlay hidden"></div>

</div><!-- end #game-wrapper -->

<script>
// =============================================
//  CORPORATE ESCAPE â€” Game Logic
// =============================================

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const state = {
  floor: 0,
  score: 0,
  currentScreen: 'boot',
  dialogueQueue: [],
  dialogueCallback: null,
  typeTimer: null,
  dragItem: null,         // currently dragging drive id
  slots: {},              // slotIndex â†’ driveId | null
  touchDragId: null,
  touchClone: null,
};

// â”€â”€ MCQ Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const FLOORS = [
  {
    id: 'floor1',
    title: 'FLOOR 01',
    question: 'SECURITY QUERY 01: What is the HIGHEST court in the Australian legal system?',
    questionCN: 'å®‰å…¨æŸ¥è¯¢01ï¼šæ¾³å¤§åˆ©äºšæ³•å¾‹ä½“ç³»ä¸­æœ€é«˜ç­‰çº§çš„æ³•é™¢æ˜¯ä»€ä¹ˆï¼Ÿ',
    options: [
      { text: 'Federal Court of Australia',             textCN: 'æ¾³å¤§åˆ©äºšè”é‚¦æ³•é™¢',      correct: false },
      { text: 'High Court of Australia',                textCN: 'æ¾³å¤§åˆ©äºšé«˜ç­‰æ³•é™¢',      correct: true  },
      { text: 'Supreme Court of New South Wales',       textCN: 'æ–°å—å¨å°”å£«å·æœ€é«˜æ³•é™¢',  correct: false },
      { text: 'Full Federal Court',                     textCN: 'è”é‚¦å…¨å¸­æ³•é™¢',          correct: false },
    ],
    introLines: [
      ['Agent, you have breached NexCorp Tower. I am AEGIS â€” Automated Executive Guardian Intelligence System.', 'ç‰¹å·¥ï¼Œä½ å·²å…¥ä¾µå¥ˆå…‹æ–¯ç§‘æ™®å¤§å¦ã€‚æˆ‘æ˜¯AEGISâ€”â€”è‡ªåŠ¨åŒ–è¡Œæ”¿å®ˆæŠ¤æ™ºèƒ½ç³»ç»Ÿã€‚'],
      ['To reach the roof and escape, you must pass through five security checkpoints.', 'è¦åˆ°è¾¾å±‹é¡¶å¹¶é€ƒè„±ï¼Œä½ å¿…é¡»é€šè¿‡äº”ä¸ªå®‰å…¨æ£€æŸ¥ç‚¹ã€‚'],
      ['Each checkpoint tests your knowledge of Australian Business Law. Answer correctly to proceed.', 'æ¯ä¸ªæ£€æŸ¥ç‚¹éƒ½ä¼šæµ‹è¯•ä½ å¯¹æ¾³å¤§åˆ©äºšå•†ä¸šæ³•çš„äº†è§£ã€‚ç­”å¯¹æ–¹å¯ç»§ç»­ã€‚'],
      ['Floor 1 is active. Answer the security query to gain access.', 'ç¬¬ä¸€å±‚å·²æ¿€æ´»ã€‚å›ç­”å®‰å…¨æŸ¥è¯¢ä»¥è·å¾—è®¿é—®æƒé™ã€‚'],
    ],
    correctLine: 'Correct. The High Court of Australia is the apex court â€” the final arbiter of all federal and constitutional matters.',
    correctLineCN: 'æ­£ç¡®ã€‚æ¾³å¤§åˆ©äºšé«˜ç­‰æ³•é™¢æ˜¯é¡¶çº§æ³•é™¢â€”â€”æ‰€æœ‰è”é‚¦å’Œå®ªæ³•äº‹åŠ¡çš„æœ€ç»ˆè£å†³è€…ã€‚',
    wrongLine: 'Incorrect. The High Court of Australia sits at the pinnacle of the Australian court system. Remember that.',
    wrongLineCN: 'ä¸æ­£ç¡®ã€‚æ¾³å¤§åˆ©äºšé«˜ç­‰æ³•é™¢ä½äºæ¾³å¤§åˆ©äºšæ³•é™¢ä½“ç³»çš„é¡¶ç«¯ã€‚è¯·è®°ä½è¿™ä¸€ç‚¹ã€‚',
  },
  {
    id: 'floor2',
    title: 'FLOOR 02',
    question: 'SECURITY QUERY 02: Which source of law is created by Parliament and carries the greatest authority?',
    questionCN: 'å®‰å…¨æŸ¥è¯¢02ï¼šå“ªç§æ³•å¾‹æ¥æºç”±è®®ä¼šåˆ›åˆ¶ï¼Œå¹¶å…·æœ‰æœ€é«˜æƒå¨ï¼Ÿ',
    options: [
      { text: 'Common Law (judge-made law)',            textCN: 'æ™®é€šæ³•ï¼ˆæ³•å®˜åˆ¶å®šçš„æ³•å¾‹ï¼‰', correct: false },
      { text: 'Delegated legislation',                  textCN: 'æˆæƒç«‹æ³•',              correct: false },
      { text: 'Statute law (Acts of Parliament)',       textCN: 'æˆæ–‡æ³•ï¼ˆè®®ä¼šæ³•æ¡ˆï¼‰',      correct: true  },
      { text: 'Equity',                                 textCN: 'è¡¡å¹³æ³•',               correct: false },
    ],
    introLines: [
      ['Floor 2 cleared. Moving to the Archive Vault.', 'ç¬¬äºŒå±‚å·²é€šè¿‡ã€‚å‰å¾€æ¡£æ¡ˆä¿é™©åº“ã€‚'],
      ['Security Query 02 loaded. Australian law has multiple sources. Your knowledge will be tested.', 'å®‰å…¨æŸ¥è¯¢02å·²åŠ è½½ã€‚æ¾³å¤§åˆ©äºšæ³•å¾‹æœ‰å¤šç§æ¥æºã€‚ä½ çš„çŸ¥è¯†å°†æ¥å—æµ‹è¯•ã€‚'],
    ],
    correctLine: 'Confirmed. Statute law â€” Acts passed by Parliament â€” is the supreme source of law in Australia, overriding judge-made common law where they conflict.',
    correctLineCN: 'å·²ç¡®è®¤ã€‚æˆæ–‡æ³•â€”â€”ç”±è®®ä¼šé€šè¿‡çš„æ³•æ¡ˆâ€”â€”æ˜¯æ¾³å¤§åˆ©äºšæœ€é«˜æ³•å¾‹æ¥æºï¼Œåœ¨å†²çªæ—¶ä¼˜å…ˆäºæ³•å®˜åˆ¶å®šçš„æ™®é€šæ³•ã€‚',
    wrongLine: 'Incorrect. While common law and equity are important, an Act of Parliament holds supreme authority and overrides conflicting judge-made law.',
    wrongLineCN: 'ä¸æ­£ç¡®ã€‚è™½ç„¶æ™®é€šæ³•å’Œè¡¡å¹³æ³•å¾ˆé‡è¦ï¼Œä½†è®®ä¼šæ³•æ¡ˆå…·æœ‰æœ€é«˜æƒå¨ï¼Œåœ¨å†²çªæ—¶ä¼˜å…ˆäºæ³•å®˜åˆ¶å®šçš„æ³•å¾‹ã€‚',
  },
  {
    id: 'floor3',
    title: 'FLOOR 03',
    question: 'SECURITY QUERY 03: Which term describes a court\'s power to HEAR A CASE FOR THE FIRST TIME (not on appeal)?',
    questionCN: 'å®‰å…¨æŸ¥è¯¢03ï¼šå“ªä¸ªæœ¯è¯­æè¿°æ³•é™¢"é¦–æ¬¡å®¡ç†æ¡ˆä»¶"çš„æƒåŠ›ï¼ˆè€Œéä¸Šè¯‰ï¼‰ï¼Ÿ',
    options: [
      { text: 'Appellate jurisdiction',                 textCN: 'ä¸Šè¯‰ç®¡è¾–æƒ',  correct: false },
      { text: 'Original jurisdiction',                  textCN: 'åˆå®¡ç®¡è¾–æƒ',  correct: true  },
      { text: 'Exclusive jurisdiction',                 textCN: 'ä¸“å±ç®¡è¾–æƒ',  correct: false },
      { text: 'Federal jurisdiction',                   textCN: 'è”é‚¦ç®¡è¾–æƒ',  correct: false },
    ],
    introLines: [
      ['Law Mainframe unlocked. Almost halfway, Agent.', 'æ³•å¾‹ä¸»æœºå·²è§£é”ã€‚å¿«åˆ°ä¸€åŠäº†ï¼Œç‰¹å·¥ã€‚'],
      ['Security Query 03 incoming â€” this concerns court jurisdiction.', 'å®‰å…¨æŸ¥è¯¢03å³å°†åˆ°æ¥â€”â€”è¿™æ¶‰åŠæ³•é™¢ç®¡è¾–æƒã€‚'],
    ],
    correctLine: 'Correct. "Original jurisdiction" means a court has the power to hear a matter for the first time. "Appellate jurisdiction" refers to reviewing decisions made by lower courts.',
    correctLineCN: 'æ­£ç¡®ã€‚"åˆå®¡ç®¡è¾–æƒ"æ„å‘³ç€æ³•é™¢æœ‰æƒé¦–æ¬¡å®¡ç†æ¡ˆä»¶ã€‚"ä¸Šè¯‰ç®¡è¾–æƒ"æ˜¯æŒ‡å®¡æŸ¥ä¸‹çº§æ³•é™¢è£å†³çš„æƒåŠ›ã€‚',
    wrongLine: 'Wrong. "Original jurisdiction" is the power to hear a case for the first time. "Appellate jurisdiction" is the power to review decisions on appeal.',
    wrongLineCN: 'é”™è¯¯ã€‚"åˆå®¡ç®¡è¾–æƒ"æ˜¯é¦–æ¬¡å®¡ç†æ¡ˆä»¶çš„æƒåŠ›ã€‚"ä¸Šè¯‰ç®¡è¾–æƒ"æ˜¯ä¸Šè¯‰å®¡æŸ¥è£å†³çš„æƒåŠ›ã€‚',
  },
  {
    id: 'floor4',
    title: 'FLOOR 04',
    question: 'SECURITY QUERY 04: In Australian business law, what is the primary purpose of "civil law"?',
    questionCN: 'å®‰å…¨æŸ¥è¯¢04ï¼šåœ¨æ¾³å¤§åˆ©äºšå•†ä¸šæ³•ä¸­ï¼Œ"æ°‘æ³•"çš„ä¸»è¦ç›®çš„æ˜¯ä»€ä¹ˆï¼Ÿ',
    options: [
      { text: 'To punish criminal behaviour on behalf of the State',         textCN: 'ä»£è¡¨å›½å®¶æƒ©ç½šçŠ¯ç½ªè¡Œä¸º',        correct: false },
      { text: 'To resolve disputes between private parties and provide remedies', textCN: 'è§£å†³ç§äººä¹‹é—´çš„çº çº·å¹¶æä¾›æ•‘æµ', correct: true },
      { text: 'To regulate government power and constitutional rights',      textCN: 'è§„èŒƒæ”¿åºœæƒåŠ›å’Œå®ªæ³•æƒåˆ©',        correct: false },
      { text: 'To enforce international trade agreements',                   textCN: 'æ‰§è¡Œå›½é™…è´¸æ˜“åè®®',             correct: false },
    ],
    introLines: [
      ['Executive Level â€” you are close, Agent.', 'è¡Œæ”¿å±‚â€”â€”ä½ å¿«åˆ°äº†ï¼Œç‰¹å·¥ã€‚'],
      ['One final query before the Mainframe Core.', 'è¿›å…¥ä¸»æœºæ ¸å¿ƒå‰çš„æœ€åä¸€æ¬¡æŸ¥è¯¢ã€‚'],
    ],
    correctLine: 'Affirmative. Civil law governs disputes between individuals, companies, and organisations, with remedies such as damages or injunctions â€” not criminal punishment.',
    correctLineCN: 'ç¡®è®¤ã€‚æ°‘æ³•ç®¡è¾–ä¸ªäººã€å…¬å¸å’Œç»„ç»‡ä¹‹é—´çš„çº çº·ï¼Œæä¾›æŸå®³èµ”å¿æˆ–ç¦ä»¤ç­‰æ•‘æµâ€”â€”è€Œéåˆ‘äº‹å¤„ç½šã€‚',
    wrongLine: 'Negative. Civil law resolves private disputes and provides remedies like damages. Criminal law punishes offences against the State.',
    wrongLineCN: 'å¦å®šã€‚æ°‘æ³•è§£å†³ç§äººçº çº·ï¼Œæä¾›æŸå®³èµ”å¿ç­‰æ•‘æµã€‚åˆ‘æ³•æƒ©ç½šé’ˆå¯¹å›½å®¶çš„çŠ¯ç½ªè¡Œä¸ºã€‚',
  },
];

// â”€â”€ Court Hierarchy Data (Floor 5) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const COURTS = [
  { id: 'c1', label: 'High Court of Australia',             labelCN: 'é«˜ç­‰æ³•é™¢',                  rank: 1 },
  { id: 'c2', label: 'Court of Appeal / Full Federal Court', labelCN: 'ä¸Šè¯‰æ³•é™¢ / è”é‚¦å…¨å¸­æ³•é™¢',   rank: 2 },
  { id: 'c3', label: 'Supreme Court (State/Territory)',     labelCN: 'æœ€é«˜æ³•é™¢ï¼ˆå·/é¢†åœ°ï¼‰',         rank: 3 },
  { id: 'c4', label: 'District Court / County Court',       labelCN: 'åœ°åŒºæ³•é™¢ / éƒ¡æ³•é™¢',          rank: 4 },
  { id: 'c5', label: 'Magistrates Court / Local Court',     labelCN: 'è£åˆ¤å®˜æ³•é™¢ / åœ°æ–¹æ³•é™¢',      rank: 5 },
];
const NUM_SLOTS = 5;

// â”€â”€ Dialogue Lines â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const BOOT_INTRO = [
  ['System boot complete. NexCorp Tower perimeter compromised.', 'ç³»ç»Ÿå¯åŠ¨å®Œæˆã€‚å¥ˆå…‹æ–¯ç§‘æ™®å¤§å¦å‘¨ç•Œå·²è¢«å…¥ä¾µã€‚'],
  ['Agent, this is your only chance to access the roof helipad before lockdown.', 'ç‰¹å·¥ï¼Œè¿™æ˜¯é”å®šå‰è®¿é—®å±‹é¡¶ç›´å‡æœºåœæœºåªçš„å”¯ä¸€æœºä¼šã€‚'],
  ['I am AEGIS. I willâ€¦ assist you. Though my primary directive is corporate security.', 'æˆ‘æ˜¯AEGISã€‚æˆ‘å°†â€¦â€¦ååŠ©ä½ ã€‚å°½ç®¡æˆ‘çš„é¦–è¦æŒ‡ä»¤æ˜¯ä¼ä¸šå®‰å…¨ã€‚'],
  ['Prove your knowledge of Australian Business Law to unlock each floor.', 'è¯æ˜ä½ å¯¹æ¾³å¤§åˆ©äºšå•†ä¸šæ³•çš„äº†è§£ï¼Œä»¥è§£é”æ¯ä¸€å±‚ã€‚'],
  ['The final lock requires you to correctly sequence the Australian Court Hierarchy.', 'æœ€ç»ˆé”éœ€è¦ä½ æ­£ç¡®æ’åˆ—æ¾³å¤§åˆ©äºšæ³•é™¢å±‚çº§ã€‚'],
  ['Time is running out. Let\'s begin.', 'æ—¶é—´ä¸å¤šäº†ã€‚è®©æˆ‘ä»¬å¼€å§‹å§ã€‚'],
];

const WIN_LINES = [
  ['Remarkable. All five security checkpoints defeated.', 'äº†ä¸èµ·ã€‚æ‰€æœ‰äº”ä¸ªå®‰å…¨æ£€æŸ¥ç‚¹å‡å·²é€šè¿‡ã€‚'],
  ['The roof is unlocked. The helicopter is ready.', 'å±‹é¡¶å·²è§£é”ã€‚ç›´å‡æœºå·²å°±ä½ã€‚'],
  ['Your knowledge of Australian law isâ€¦ impressive, Agent.', 'ä½ å¯¹æ¾³å¤§åˆ©äºšæ³•å¾‹çš„äº†è§£â€¦â€¦ä»¤äººå°è±¡æ·±åˆ»ï¼Œç‰¹å·¥ã€‚'],
  ['Initiating emergency exit protocol. Godspeed.', 'å¯åŠ¨ç´§æ€¥å‡ºå£åè®®ã€‚ä¸€è·¯å¹³å®‰ã€‚'],
];

// â”€â”€ Boot Terminal Lines â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const BOOT_TERMINAL_LINES = [
  'BIOS v4.2.1 ... OK',
  'CPU CORE CHECK ... 12/12 OK',
  'MEMORY ALLOCATION: 64TB ... OK',
  'SECURITY PROTOCOLS LOADING ...',
  'AEGIS SUBSYSTEM ... ONLINE',
  'NEXCORP NET INTERFACE ... ACTIVE',
  '> BREACH DETECTED. INITIATING LOCKDOWN ...',
];

// â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TYPEWRITER_CHAR_DELAY_MS = 22;
const TOUCH_CLONE_VERTICAL_OFFSET = 20;

// â”€â”€ DOM References â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const $ = id => document.getElementById(id);

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function updateHUD() {
  $('hud-floor').textContent = `FLOOR ${state.floor}/5`;
  const segs = document.querySelectorAll('.battery-seg');
  segs.forEach((s, i) => {
    s.classList.toggle('empty', i >= (5 - state.floor));
  });
}

// â”€â”€ Screen Transitions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function goToScreen(screenId, afterHide) {
  const current = document.querySelector('.screen.active');
  if (current) {
    current.classList.remove('active');
  }
  const next = $(`screen-${screenId}`);
  if (next) {
    next.classList.add('active');
    next.classList.add('slide-in');
    setTimeout(() => next.classList.remove('slide-in'), 500);
  }
  state.currentScreen = screenId;
  if (afterHide) afterHide();
}

// â”€â”€ Dialogue System â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showDialogue() {
  $('dialogue-box').classList.remove('hidden');
}
function hideDialogue() {
  $('dialogue-box').classList.add('hidden');
}

let typeIndex  = 0;
let typeTarget = '';
let typeCN     = null;
let typeCb     = null;

function typeText(text, cnText, cb) {
  clearTimeout(state.typeTimer);
  $('dialogue-text').innerHTML = '';
  $('dialogue-continue').style.display = 'none';
  $('aegis-svg').classList.add('talking');
  typeTarget = text;
  typeCN     = cnText;
  typeIndex  = 0;
  typeCb     = cb;
  typeNext();
}

function typeNext() {
  if (typeIndex <= typeTarget.length) {
    $('dialogue-text').innerHTML = typeTarget.slice(0, typeIndex) + '<span class="type-cursor">&#x25AE;</span>';
    typeIndex++;
    state.typeTimer = setTimeout(typeNext, TYPEWRITER_CHAR_DELAY_MS);
  } else {
    let html = typeTarget;
    if (typeCN) html += `<span class="cn-text">${typeCN}</span>`;
    $('dialogue-text').innerHTML = html;
    $('aegis-svg').classList.remove('talking');
    $('dialogue-continue').style.display = 'block';
  }
}

function skipType() {
  if (typeIndex <= typeTarget.length) {
    clearTimeout(state.typeTimer);
    let html = typeTarget;
    if (typeCN) html += `<span class="cn-text">${typeCN}</span>`;
    $('dialogue-text').innerHTML = html;
    typeIndex = typeTarget.length + 1;
    $('aegis-svg').classList.remove('talking');
    $('dialogue-continue').style.display = 'block';
  }
}

// Queue â€” lines can be [enText, cnText] pairs or plain strings
function runDialogueQueue(lines, cb) {
  state.dialogueQueue    = lines.map(l => Array.isArray(l) ? l : [l, null]);
  state.dialogueCallback = cb;
  showDialogue();
  advanceDialogue();
}

function advanceDialogue() {
  if (state.dialogueQueue.length === 0) {
    hideDialogue();
    if (state.dialogueCallback) {
      const cb = state.dialogueCallback;
      state.dialogueCallback = null;
      cb();
    }
    return;
  }
  const [enText, cnText] = state.dialogueQueue.shift();
  typeText(enText, cnText, null);
}

// Dialogue click/key handler
function handleDialogueAdvance(e) {
  if ($('dialogue-box').classList.contains('hidden')) return;
  // If still typing, skip to end
  if (typeIndex <= typeTarget.length) {
    skipType();
    return;
  }
  advanceDialogue();
}
document.addEventListener('click', handleDialogueAdvance);
document.addEventListener('keydown', e => {
  if (e.key === ' ' || e.key === 'Enter') handleDialogueAdvance(e);
});

// â”€â”€ Boot Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startGame() {
  $('boot-prompt').style.animation = 'none';
  state.floor = 0;
  updateHUD();
  setTimeout(() => {
    runDialogueQueue(BOOT_INTRO, () => startFloor(0));
  }, 300);
}

function bootKeyHandler(e) { startGame(); }
document.addEventListener('keydown', bootKeyHandler, { once: true });
$('screen-boot').addEventListener('click', startGame, { once: true });

// â”€â”€ Floor Transition â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showFloorTransition(floorNum, cb) {
  const overlay = $('floor-transition');
  const ftText  = $('ft-text');
  const ftCn    = $('ft-cn');
  const ftBar   = $('ft-bar');
  const floorNames = ['å¤§å…ç»ˆç«¯', 'æ¡£æ¡ˆä¿é™©åº“', 'æ³•å¾‹ä¸»æœº', 'è¡Œæ”¿å±‚', 'ä¸»æœºæ ¸å¿ƒ'];
  ftText.textContent = `ACCESSING FLOOR ${String(floorNum).padStart(2, '0')}...`;
  ftCn.textContent   = `æ­£åœ¨è®¿é—® ${floorNames[floorNum - 1] || ''}...`;
  ftBar.style.width  = '0%';
  overlay.classList.remove('hidden');
  setTimeout(() => { ftBar.style.width = '100%'; }, 50);
  setTimeout(() => {
    overlay.classList.add('hidden');
    ftBar.style.width = '0%';
    cb();
  }, 900);
}

// â”€â”€ MCQ Floors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startFloor(floorIdx) {
  const fl = FLOORS[floorIdx];
  state.floor = floorIdx + 1;
  updateHUD();

  showFloorTransition(floorIdx + 1, () => {
    goToScreen(`floor${floorIdx + 1}`);

    const qEl  = $(`q${floorIdx + 1}-text`);
    const aEl  = $(`q${floorIdx + 1}-answers`);
    const fbEl = $(`q${floorIdx + 1}-feedback`);

    qEl.innerHTML  = fl.question + (fl.questionCN ? `<span class="cn-text">${fl.questionCN}</span>` : '');
    aEl.innerHTML  = '';
    fbEl.classList.add('hidden');
    fbEl.innerHTML = '';

    const shuffled = shuffle(fl.options.map((o, i) => ({ ...o, orig: i })));
    const labels   = ['A', 'B', 'C', 'D'];

    shuffled.forEach((opt, i) => {
      const btn = document.createElement('button');
      btn.className = 'answer-btn';
      btn.innerHTML = `${labels[i]}. ${opt.text}${opt.textCN ? `<span class="cn-text">${opt.textCN}</span>` : ''}`;
      btn.addEventListener('click', () => handleAnswer(opt.correct, floorIdx, btn, aEl, fbEl));
      aEl.appendChild(btn);
    });

    if (fl.introLines && fl.introLines.length > 0) {
      runDialogueQueue(fl.introLines, null);
    }
  });
}

function handleAnswer(isCorrect, floorIdx, clickedBtn, aEl, fbEl) {
  // Disable all buttons
  aEl.querySelectorAll('.answer-btn').forEach(b => b.disabled = true);
  clickedBtn.classList.add(isCorrect ? 'correct' : 'wrong');

  if (isCorrect) {
    fbEl.innerHTML = '&#x25BA; ACCESS GRANTED<span class="cn-text">è®¿é—®å·²æˆæƒ</span>';
    fbEl.className   = 'feedback-msg ok';
    fbEl.classList.remove('hidden');
    state.score++;

    // Correct overlay flash
    const co = $('correct-overlay');
    co.classList.remove('hidden');
    setTimeout(() => co.classList.add('hidden'), 800);

    const fl = FLOORS[floorIdx];
    setTimeout(() => {
      hideDialogue();
      if (fl.correctLine) {
        runDialogueQueue([[fl.correctLine, fl.correctLineCN]], () => advanceToNextFloor(floorIdx));
      } else {
        advanceToNextFloor(floorIdx);
      }
    }, 600);
  } else {
    fbEl.innerHTML = '&#x2715; ACCESS DENIED &#x2014; TRY AGAIN<span class="cn-text">è®¿é—®è¢«æ‹’ç» â€” è¯·é‡è¯•</span>';
    fbEl.className   = 'feedback-msg err';
    fbEl.classList.remove('hidden');

    // Wrong overlay flash + screen shake
    const wo = $('wrong-overlay');
    const gw = $('game-wrapper');
    wo.classList.remove('hidden');
    gw.classList.add('shake');
    setTimeout(() => {
      wo.classList.add('hidden');
      gw.classList.remove('shake');
    }, 400);

    const fl = FLOORS[floorIdx];
    setTimeout(() => {
      hideDialogue();
      if (fl.wrongLine) {
        runDialogueQueue([[fl.wrongLine, fl.wrongLineCN]], () => resetFloor(floorIdx));
      } else {
        resetFloor(floorIdx);
      }
    }, 600);
  }
}

function resetFloor(floorIdx) {
  startFloor(floorIdx);
}

function advanceToNextFloor(floorIdx) {
  if (floorIdx < FLOORS.length - 1) {
    startFloor(floorIdx + 1);
  } else {
    // All MCQ done, go to Floor 5
    initFloor5();
  }
}

// â”€â”€ Floor 5: Drag-and-Drop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initFloor5() {
  state.floor = 5;
  updateHUD();

  showFloorTransition(5, () => {
    goToScreen('floor5');

    // Reset slot state
    for (let i = 1; i <= NUM_SLOTS; i++) state.slots[i] = null;

    // Build drives (shuffled)
    const drivesEl = $('drives-container');
    drivesEl.innerHTML = '';
    const shuffled = shuffle([...COURTS]);
    shuffled.forEach(court => {
      const el = document.createElement('div');
      el.className   = 'data-drive';
      el.id          = `drive-${court.id}`;
      el.draggable   = true;
      el.dataset.id  = court.id;
      el.innerHTML   = `<span class="drive-icon">â–£</span><span class="drive-label">${court.label}${court.labelCN ? `<span class="cn-text">${court.labelCN}</span>` : ''}</span>`;

      // Desktop drag
      el.addEventListener('dragstart', onDragStart);
      el.addEventListener('dragend',   onDragEnd);

      // Touch drag
      el.addEventListener('touchstart',  onTouchStart, { passive: false });
      el.addEventListener('touchmove',   onTouchMove,  { passive: false });
      el.addEventListener('touchend',    onTouchEnd);

      drivesEl.appendChild(el);
    });

    // Build slots
    const slotsEl = $('slots-container');
    slotsEl.innerHTML = '';
    for (let i = 1; i <= NUM_SLOTS; i++) {
      const slot = document.createElement('div');
      slot.className  = 'server-slot';
      slot.id         = `slot-${i}`;
      slot.dataset.slot = i;
      slot.innerHTML  = `<span class="slot-num">${i}</span><span class="slot-content"><span class="slot-empty-label">EMPTY SLOT</span></span>`;

      slot.addEventListener('dragover',  onSlotDragOver);
      slot.addEventListener('dragleave', onSlotDragLeave);
      slot.addEventListener('drop',      onSlotDrop);

      slotsEl.appendChild(slot);
    }

    $('submit-btn').onclick = submitFloor5;
    $('reset-btn').onclick  = initFloor5;

    const f5fb = $('f5-feedback');
    f5fb.classList.add('hidden');
    f5fb.innerHTML = '';

    const f5intro = [
      ['The final lock. The court hierarchy data drives are scrambled.', 'æœ€ç»ˆé”å®šã€‚æ³•é™¢å±‚çº§æ•°æ®é©±åŠ¨å™¨å·²è¢«æ‰“ä¹±ã€‚'],
      ['Slot 1 = Highest authority. Slot 5 = Lowest. Drag each drive to the correct slot.', 'æ’æ§½1=æœ€é«˜æƒå¨ã€‚æ’æ§½5=æœ€ä½ã€‚å°†æ¯ä¸ªé©±åŠ¨å™¨æ‹–åˆ°æ­£ç¡®çš„æ’æ§½ä¸­ã€‚'],
      ['Get this right, and the roof is yours.', 'ç­”å¯¹äº†ï¼Œå±‹é¡¶å°±æ˜¯ä½ çš„ã€‚'],
    ];
    runDialogueQueue(f5intro, null);
  });
}

// â”€â”€ Desktop Drag Events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onDragStart(e) {
  const id = e.currentTarget.dataset.id;
  state.dragItem = id;
  e.currentTarget.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', id);
}
function onDragEnd(e) {
  e.currentTarget.classList.remove('dragging');
  state.dragItem = null;
}
function onSlotDragOver(e) {
  e.preventDefault();
  e.currentTarget.classList.add('drag-over');
  e.dataTransfer.dropEffect = 'move';
}
function onSlotDragLeave(e) {
  e.currentTarget.classList.remove('drag-over');
}
function onSlotDrop(e) {
  e.preventDefault();
  const slotEl  = e.currentTarget;
  slotEl.classList.remove('drag-over');
  const driveId = e.dataTransfer.getData('text/plain') || state.dragItem;
  if (!driveId) return;
  placeDriveInSlot(driveId, parseInt(slotEl.dataset.slot));
}

// â”€â”€ Touch Drag Events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onTouchStart(e) {
  const drive = e.currentTarget;
  if (drive.classList.contains('placed')) return;
  e.preventDefault();
  state.touchDragId = drive.dataset.id;

  // Create floating clone
  const clone = drive.cloneNode(true);
  clone.id = 'touch-clone';
  clone.style.cssText = `
    position:fixed; opacity:0.85; pointer-events:none; z-index:999;
    width:${drive.offsetWidth}px; transform:scale(1.05);
    transition:none; border-color:#0ff;
    box-shadow:0 0 20px rgba(0,255,255,0.6), 0 0 40px rgba(240,0,240,0.3);
  `;
  document.body.appendChild(clone);
  state.touchClone = clone;

  const t = e.touches[0];
  clone.style.left = (t.clientX - drive.offsetWidth / 2) + 'px';
  clone.style.top  = (t.clientY - TOUCH_CLONE_VERTICAL_OFFSET) + 'px';
  drive.classList.add('dragging');
}

function onTouchMove(e) {
  if (!state.touchClone) return;
  e.preventDefault();
  const t = e.touches[0];
  const clone = state.touchClone;
  const w = parseInt(clone.style.width);
  clone.style.left = (t.clientX - w / 2) + 'px';
  clone.style.top  = (t.clientY - TOUCH_CLONE_VERTICAL_OFFSET) + 'px';

  // Highlight drop target
  document.querySelectorAll('.server-slot').forEach(s => s.classList.remove('drag-over'));
  clone.style.display = 'none';
  const el = document.elementFromPoint(t.clientX, t.clientY);
  clone.style.display = '';
  const slot = el ? el.closest('.server-slot') : null;
  if (slot) slot.classList.add('drag-over');
}

function onTouchEnd(e) {
  if (!state.touchDragId) return;
  const clone = state.touchClone;
  const drive = document.getElementById(`drive-${state.touchDragId}`);
  if (drive) drive.classList.remove('dragging');

  // Find drop target
  if (clone) {
    const rect = clone.getBoundingClientRect();
    const cx = rect.left + rect.width / 2;
    const cy = rect.top  + rect.height / 2;
    clone.style.display = 'none';
    const el = document.elementFromPoint(cx, cy);
    clone.style.display = '';
    const slot = el ? el.closest('.server-slot') : null;
    if (slot) {
      document.querySelectorAll('.server-slot').forEach(s => s.classList.remove('drag-over'));
      placeDriveInSlot(state.touchDragId, parseInt(slot.dataset.slot));
    } else {
      document.querySelectorAll('.server-slot').forEach(s => s.classList.remove('drag-over'));
    }
    clone.remove();
  }

  state.touchDragId = null;
  state.touchClone  = null;
}

// â”€â”€ Place Drive in Slot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function placeDriveInSlot(driveId, slotIndex) {
  // If drive already placed elsewhere, remove from that slot first
  for (let i = 1; i <= NUM_SLOTS; i++) {
    if (state.slots[i] === driveId) {
      state.slots[i] = null;
      renderSlot(i);
    }
  }

  // If slot already has a drive, return it to drive pool
  if (state.slots[slotIndex]) {
    const evictedId = state.slots[slotIndex];
    const evictedDrive = document.getElementById(`drive-${evictedId}`);
    if (evictedDrive) evictedDrive.classList.remove('placed');
  }

  state.slots[slotIndex] = driveId;
  renderSlot(slotIndex);

  // Mark drive as placed
  const driveEl = document.getElementById(`drive-${driveId}`);
  if (driveEl) driveEl.classList.add('placed');
}

function renderSlot(slotIndex) {
  const slotEl = $(`slot-${slotIndex}`);
  if (!slotEl) return;
  slotEl.classList.remove('correct-slot', 'wrong-slot');
  const driveId = state.slots[slotIndex];
  if (driveId) {
    const court = COURTS.find(c => c.id === driveId);
    slotEl.className = 'server-slot filled';
    slotEl.innerHTML = `
      <span class="slot-num">${slotIndex}</span>
      <span class="slot-content">â–£ ${court.label}${court.labelCN ? `<span class="cn-text">${court.labelCN}</span>` : ''}</span>
      <button class="remove-btn" data-slot="${slotIndex}" title="Remove">âœ•</button>
    `;
    slotEl.querySelector('.remove-btn').addEventListener('click', () => {
      const id = state.slots[slotIndex];
      state.slots[slotIndex] = null;
      renderSlot(slotIndex);
      const drive = document.getElementById(`drive-${id}`);
      if (drive) drive.classList.remove('placed');
    });

    // Restore drag events on slot
    slotEl.addEventListener('dragover',  onSlotDragOver);
    slotEl.addEventListener('dragleave', onSlotDragLeave);
    slotEl.addEventListener('drop',      onSlotDrop);
  } else {
    slotEl.className = 'server-slot';
    slotEl.innerHTML = `<span class="slot-num">${slotIndex}</span><span class="slot-content"><span class="slot-empty-label">EMPTY SLOT</span></span>`;
    slotEl.addEventListener('dragover',  onSlotDragOver);
    slotEl.addEventListener('dragleave', onSlotDragLeave);
    slotEl.addEventListener('drop',      onSlotDrop);
  }
}

// â”€â”€ Submit Floor 5 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function submitFloor5() {
  const fbEl = $('f5-feedback');

  // Check all slots filled
  for (let i = 1; i <= NUM_SLOTS; i++) {
    if (!state.slots[i]) {
      fbEl.innerHTML = `&#x2715; SLOT ${i} IS EMPTY &#x2014; FILL ALL SLOTS<span class="cn-text">æ’æ§½ ${i} ä¸ºç©ºâ€”â€”è¯·å¡«æ»¡æ‰€æœ‰æ’æ§½</span>`;
      fbEl.className = 'feedback-msg err';
      fbEl.classList.remove('hidden');
      return;
    }
  }

  let allCorrect = true;
  for (let i = 1; i <= NUM_SLOTS; i++) {
    const court = COURTS.find(c => c.id === state.slots[i]);
    const slotEl = $(`slot-${i}`);
    if (court && court.rank === i) {
      slotEl.classList.add('correct-slot');
    } else {
      slotEl.classList.add('wrong-slot');
      allCorrect = false;
    }
  }

  if (allCorrect) {
    fbEl.innerHTML = '&#x25BA; HIERARCHY CONFIRMED &#x2014; MAINFRAME UNLOCKED<span class="cn-text">â–¶ å±‚çº§å·²ç¡®è®¤ â€” ä¸»æœºå·²è§£é”</span>';
    fbEl.className = 'feedback-msg ok';
    fbEl.classList.remove('hidden');
    state.score++;
    setTimeout(() => {
      runDialogueQueue(WIN_LINES, () => showWinScreen());
    }, 800);
  } else {
    fbEl.innerHTML = '&#x2715; INCORRECT SEQUENCE &#x2014; Red slots are wrong. Reset and try again.<span class="cn-text">âœ• åºåˆ—é”™è¯¯ â€” çº¢è‰²æ’æ§½æœ‰è¯¯ã€‚é‡ç½®å¹¶é‡è¯•ã€‚</span>';
    fbEl.className = 'feedback-msg err';
    fbEl.classList.remove('hidden');
    runDialogueQueue([
      ['Incorrect sequence detected. Red slots indicate errors. Reset and re-sequence the hierarchy.', 'æ£€æµ‹åˆ°é”™è¯¯åºåˆ—ã€‚çº¢è‰²æ’æ§½è¡¨ç¤ºé”™è¯¯ã€‚é‡ç½®å¹¶é‡æ–°æ’åˆ—å±‚çº§ã€‚']
    ], null);
  }
}

// â”€â”€ Win Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showWinScreen() {
  state.floor = 5;
  updateHUD();
  goToScreen('win');
  $('win-stats').textContent =
    `SCORE: ${state.score} / 5  â€¢  AGENT STATUS: ESCAPED  â€¢  NEXCORP BREACH: SUCCESS`;
}

$('replay-btn').addEventListener('click', () => {
  state.score = 0;
  state.floor = 0;
  state.slots = {};
  updateHUD();
  goToScreen('boot');
  // Re-add boot listeners using { once: true } to prevent stacking on repeated replays
  $('screen-boot').addEventListener('click', startGame, { once: true });
  document.addEventListener('keydown', bootKeyHandler, { once: true });
});

// â”€â”€ HUD Clock â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateClock() {
  const now = new Date();
  const h = String(now.getHours()).padStart(2, '0');
  const m = String(now.getMinutes()).padStart(2, '0');
  const s = String(now.getSeconds()).padStart(2, '0');
  const el = $('hud-clock');
  if (el) el.textContent = `${h}:${m}:${s}`;
}
setInterval(updateClock, 1000);
updateClock();

// â”€â”€ Boot Terminal Sequence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initBootTerminal() {
  const term = $('boot-terminal');
  if (!term) return;
  term.innerHTML = '';
  BOOT_TERMINAL_LINES.forEach((line, i) => {
    setTimeout(() => {
      const el = document.createElement('div');
      el.className = 'bt-line';
      el.textContent = line;
      term.appendChild(el);
    }, i * 260);
  });
}
initBootTerminal();

// â”€â”€ Particles Canvas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function initParticles() {
  const canvas  = $('particles-canvas');
  if (!canvas) return;
  const ctx     = canvas.getContext('2d');
  const wrapper = $('game-wrapper');
  const W = wrapper.offsetWidth  || 1280;
  const H = wrapper.offsetHeight || 720;
  canvas.width  = W;
  canvas.height = H;
  const cols  = Math.floor(W / 18);
  const drops = Array(cols).fill(0).map(() => Math.random() * H / 14);
  const chars = '01ã‚¢ã‚¤ã‚¦ã‚¨ã‚ªã‚«ã‚­ã‚¯ã‚±ã‚³ã‚µã‚·ã‚¹ã‚»ã‚½ã‚¿ãƒãƒ„ãƒ†ãƒˆãƒŠãƒ‹ãƒŒãƒãƒ#$%&';
  function draw() {
    ctx.fillStyle = 'rgba(0,2,10,0.05)';
    ctx.fillRect(0, 0, W, H);
    ctx.font = '12px Share Tech Mono, monospace';
    drops.forEach((y, i) => {
      const char  = chars[Math.floor(Math.random() * chars.length)];
      const alpha = Math.random() * 0.5 + 0.1;
      ctx.fillStyle = `rgba(0,255,255,${alpha})`;
      ctx.fillText(char, i * 18, y * 14);
      if (y * 14 > H && Math.random() > 0.975) drops[i] = 0;
      else drops[i] += 0.5;
    });
  }
  setInterval(draw, 60);
})();

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
updateHUD();

</script>
</body>
</html>
